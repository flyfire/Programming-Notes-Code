# 协程

---
## 1 协程的概念

### 子程序

子程序即函数，函数调用是通过调用栈来实现的，而栈只有一个入口和一个出口，所以可以认为函数的调用是线性的，
调用顺序非常明确

### 协程

协程看上去也是子程序，但执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行，
可以看出协程中函数可以有多个入口。

### 实现

>协程存在的意义：**让异步代码看上去像同步代码，直接自然易懂。至于它如何做到这一点，可能各家的语言实现各有不同**，
但协程给人的感觉更像是底层并发 API（比如线程）的语法糖。当然，如果你愿意，
我们通常所谓的线程也可以被称作操作系统级 API 的语法糖了吧，毕竟各家语言对于线程的实现也各有不同。

可以看出，协程并不局限于单线程，本质上是通过对底层API的封装，让异步编程更加自然易懂。

---
## 2 kotlin协程

>kotlin协程的异步需要依赖比它更底层的 API 支持，那么在Kotlin当中，这个所谓的底层API就非线程莫属了。

### 协程概念和作用

一些耗时操作(网络IO、文件IO、CPU/GPU密集型任务)会阻塞线程直到操作完成，
Kotlin的协程提供一种避免阻塞且更廉价可控的操作: 协程挂起(coroutine suspension)，
协程将复杂异步操作放入底层库中，**程序逻辑可顺序表达**，以此简化异步编程，
该底层库将用户代码包装为**回调/订阅**事件在**不同线程(甚至不同机器)调度执行**!

### 线程阻塞和协程挂起的区别(Blocking VS Suspending)

协程是通过编译技术实现(不需要虚拟机VM/操作系统OS的支持)，通过插入相关代码来生效！ 与之相反，
线程/进程是需要虚拟机VM/操作系统OS的支持，通过调度CPU执行生效!

- **线程阻塞的代价昂贵**， 尤其在高负载时的可用线程很少，阻塞线程会导致一些重要任务缺少可用线程而被延迟!
- 协程挂起几乎无代价，无需上下文切换或涉及OS， 最重要的是，协程挂起可由用户控制：
可决定挂起时发生什么，并根据需求优化/记录日志/拦截!另一个不同之处是，
**协程不能在随机指令中挂起，只能在挂起点挂起(调用标记函数)**

### 实验性阶段

自Kotlin 1.1起开始有协程(coroutines)，但目前还是实验性功能(experimental)!但是协程还处于实验性阶段，
不建议在实际项目中大规模使用，最好等待官方发布正式版才可用于实际生产。

协程是独立模块，要使用Kotlin功能，需要通过在构建系统(gradle)中引入Kotlin的写成模块。

### 理解

Kotlin协程中应用了多线程，但是通过编译技术(官方如是说)可以达到不需要虚拟机VM/操作系统OS的支持

---
## 引用

- [kotlin coroutines docs](https://www.kotlincn.net/docs/reference/coroutines.html)
- [kotlin coroutines GitHub](https://github.com/Kotlin/kotlinx.coroutines)
- [我理解的协程](https://www.zybuluo.com/kuailezhishang/note/128823)
- [协程(廖雪峰)](http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/0013868328689835ecd883d910145dfa8227b539725e5ed000)
- [协程的好处有哪些？](https://www.zhihu.com/question/20511233/answer/24260355)
- [深入理解 Kotlin Coroutine-1](http://www.kotliner.cn/2017/01/30/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Kotlin%20Coroutine/)
- [深入理解 Kotlin Coroutine-2](https://blog.kotliner.cn/2017/02/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Kotlin%20Coroutine%20(2)/)
- [深入理解 Kotlin Coroutine-3](https://blog.kotliner.cn/2017/06/19/deep-in-coroutine-III/)
- [Kotlin Primer·第七章·协程库](https://www.kymjs.com/code/2017/11/24/01/)
