# 商城项目

- JavaEE基础知识练手项目
- 没有使用任何框架

---
##  1 模块划分

1. 用户模块
    - 用户注册功能
    - 发送邮件
    - 激活用户
    - 表单的校验
    - 用户的登录功能
    - 自动登录
    - 用户的注销功能
2. 商品模块
   - 首页热门商品和最新商品功能
   - 商品分类
   - 商品的列表（分页）
   - 商品详细信息
   - 浏览记录功能
3. 购物车模块
    - 将商品加入购物车
    - 展示购物车功能
4. 订单模块（多表和事务）
    - 提交订单
    - 展示订单
    - 在线支付
5. 后台的分类的模块
    - 分类信息的增删改查
6. 后台的商品模块
    - 商品的信息的增删改查（文件上传）
7. 后台的订单的模块
    - 所有的订单的信息展示

---
## 2 开发流程

### 准备

1. 创建项目
2. 项目分包
3. 引入依赖库：servlet、c3p0、BeanUtils、JavaMail、MySQL-Connector、DBUtils、Redis
4. 配置文件：c3p0
5. 数据库：创建数据库、创建表、导入数据

### 基础功能划分

- 按照模块划分功能：一个模块的功能由一个Servlet统一控制，一个方法对应一个模块功能，不同功能由请求参数中的op区分。
- 面向接口编程，使用配置文件控制对象的实例化


### 用户注册

1. register.jsp
    - 前端校验
    - jQuery.validate创建使用
    - Ajax校验用户名是否存在，CheckUsernameServlet.java
2. 用户注册控制：RegisterServlet，领域对象：User
    - 表单数据->User对象使用BeanUtils，配置类型转换器
3. 处理用户相关业务：UserService
4. 用户数据访问：UserDao
5. 发送邮件：邮件服务器，配置客户端验证码
6. 处理用户激活：ActiveServlet

### 首页商品

1. 处理首页商品请求
2. 商品业务相关处理：ProductService
3. 商品数据访问：ProductDao
4. 数据转发到index.jsp
5. 默认页面，default.jap转发到ProductServlet，调用获取首页商品功能。
6. 抽取header.jsp加载类别，使用ajax加载
7. 使用Redis缓存商品类别，避免每次从MySQL查询
8. 点击商品类别，进入具体商品类别列表页面并且分页展示商品
    - 先跳转到分页的ProductServlet，调用商品分页功能
    - 然后转发到product_list.jsp
9. 列表页点击商品进入商品详情页
    - 加入购物车功能，使用Session存储购物车中的商品
    - 使用cookie记录商品浏览历史
10. 由于商品类别列表页面需要展示用户浏览的历史，ProductServlet中还要根据cookie查询浏览历史

###  订单

1. 理解Order和OrderItem表的设计，一个Order对应多个OrderItem，查询的时候，根据orderId查询所有的订单项

### 在线支付

- 第三方支付：连连支付、易宝支付

支付流程：四个角色：客户端、后台、易宝支付平台、银行

- 客户端提交数据到后台
- 后台对数据进行，包括加密数据和数据
- 加密返回给客户端
- 客户端携带加密数据和数据重定向到支付平台
- 支付平台校验加密数据和数据摘要，校验完成后执行支付
- 支付后易宝支付平台同时告知后台和客户端支付成功
- 后台收到支付平台的通知后需要告知支付平台收到回调，否则支付平台会反复的通知后台

### 权限控制

- 对于需要登录才能访问的界面，使用Filter进行控制，没有登录则重定向到登录界面
- 需要控制权限的可以放在单独的文件夹，这样方便Filter编写过滤模式

### 管理后台

- 管理员登录
- 添加商品、图片上传
- frame标签
- popup-layer.js 弹出层

---
##  3 运行项目

- 准备tomcat
- 开启本地redis
- MySQL已配置好

---
## 4 总结

1. 提交表单字段、数据实体、数据库字段名保持一致。
2. 明确各层职责，各种异常的处理，是抛出还是吞掉
3. 统一格式的字段转换，Date<->String
4. 虽然数据结构相同、字段也相同，但是如果使用的地方不一样，就应该定义不同的实体
5. 请求转发的问题：比如Servlet转发到一个jsp，那么jsp中引用的资源是相对于Servlet路径的，如果Servlet的上级路径与jsp的上级路径不一致，那么jsp中引用的资源将会失效
6. 明确开发过程中的默认路径：
    - 请求转发的两种方式的默认对应路径
    - cookie的默认路径